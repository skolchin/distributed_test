<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ray Job Manager</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .status-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .status-card {
            background-color: white;
            border-radius: 5px;
            padding: 10px 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            flex: 1;
        }
        
        .status-card h3 {
            margin: 5px 0;
            font-size: 14px;
            color: var(--dark-color);
        }
        
        .status-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .panel {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .panel-header {
            background-color: var(--dark-color);
            color: white;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-body {
            padding: 12px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th, td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
            font-size: 13px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            font-size: 13px;
        }
        
        input, select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 13px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        
        .checkbox-label input {
            width: auto;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 5px;
            width: 800px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 12px 15px;
        }
        
        .modal-footer {
            padding: 12px 15px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        
        .close {
            font-size: 20px;
            cursor: pointer;
        }
        
        .job-status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .status-running {
            background-color: #d4edff;
            color: var(--primary-color);
        }
        
        .status-completed {
            background-color: #d4f5e0;
            color: var(--success-color);
        }
        
        .status-failed {
            background-color: #fadbd8;
            color: var(--danger-color);
        }
        
        .status-pending {
            background-color: #fdebd0;
            color: var(--warning-color);
        }
        
        .toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .new-job-form {
            background-color: white;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }
        
        .parameters-section {
            margin-top: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 10px;
            display: none;
        }
        
        .parameters-section.expanded {
            display: block;
        }
        
        .toggle-parameters {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 13px;
            cursor: pointer;
            display: inline-block;
            margin-top: 5px;
        }
        
        .parameter-row {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .parameter-row input {
            flex: 1;
        }
        
        .parameter-row button {
            width: 30px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .add-parameter {
            margin-top: 5px;
        }
        
        .output-link {
            color: var(--primary-color);
            text-decoration: underline;
            cursor: pointer;
        }
        
        .tasks-table {
            width: 100%;
            margin-top: 10px;
            font-size: 13px;
            border-collapse: collapse;
        }
        
        .tasks-table th, 
        .tasks-table td {
            padding: 6px 8px;
            border: 1px solid #ddd;
        }
        
        .tasks-table th {
            background-color: #f5f5f5;
        }
        
        .task-status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 style="font-size: 20px; margin: 0;">Ray Job Manager</h1>
            <div>
                <span id="last-updated" style="font-size: 13px;">Last updated: Never</span>
            </div>
        </div>
        
        <div class="status-bar">
            <div class="status-card">
                <h3>Running Jobs</h3>
                <div class="status-value" id="running-jobs">0</div>
            </div>
            <div class="status-card">
                <h3>Completed Jobs</h3>
                <div class="status-value" id="completed-jobs">0</div>
            </div>
            <div class="status-card">
                <h3>Failed Jobs</h3>
                <div class="status-value" id="failed-jobs">0</div>
            </div>
        </div>
        
        <div class="new-job-form">
            <h3 style="margin-top: 0; font-size: 16px;">Submit New Job</h3>
            <form id="job-submit-form">
                <div class="form-group">
                    <label for="job-type">Job Type</label>
                    <select id="job-type" required>
                        <option value="">Select a job type</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="as-background"> Run as background job
                    </label>
                </div>
                
                <a class="toggle-parameters">+ Add parameters</a>
                <div class="parameters-section" id="parameters-section">
                    <div id="parameters-container">
                        <!-- Parameters will be added here -->
                    </div>
                    <button type="button" class="btn btn-primary add-parameter" id="add-parameter">Add Parameter</button>
                </div>
                
                <div class="form-group" style="margin-top: 15px;">
                    <button type="submit" class="btn btn-primary">Submit Job</button>
                    <button type="button" class="btn" id="refresh-jobs">Refresh List</button>
                </div>
            </form>
        </div>
        
        <div class="panel">
            <div class="panel-header">
                <h3 style="margin: 0; font-size: 16px;">Job List</h3>
                <div class="toolbar">
                    <input type="text" id="job-search" placeholder="Search jobs..." style="width: 200px;">
                </div>
            </div>
            <div class="panel-body">
                <table id="jobs-table">
                    <thead>
                        <tr>
                            <th>Job ID</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Tasks</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Jobs will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="modal" id="job-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin: 0; font-size: 16px;">Job Details</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" id="job-details-content">
                Loading job details...
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="cancel-job-btn">Cancel Job</button>
                <button class="btn" id="close-modal-btn">Close</button>
            </div>
        </div>
    </div>
    
    <script>
        // Base API URL - adjust as needed
        const API_BASE_URL = '/';
        
        // Current selected job ID for modal
        let currentJobId = null;
        
        // DOM Elements
        const lastUpdatedEl = document.getElementById('last-updated');
        const runningJobsEl = document.getElementById('running-jobs');
        const completedJobsEl = document.getElementById('completed-jobs');
        const failedJobsEl = document.getElementById('failed-jobs');
        const jobsTableBody = document.querySelector('#jobs-table tbody');
        const jobTypeSelect = document.getElementById('job-type');
        const jobSubmitForm = document.getElementById('job-submit-form');
        const jobDetailsModal = document.getElementById('job-details-modal');
        const jobDetailsContent = document.getElementById('job-details-content');
        const closeModalBtn = document.querySelector('.close');
        const closeModalBtnFooter = document.getElementById('close-modal-btn');
        const cancelJobBtn = document.getElementById('cancel-job-btn');
        const refreshJobsBtn = document.getElementById('refresh-jobs');
        const jobSearchInput = document.getElementById('job-search');
        const parametersSection = document.getElementById('parameters-section');
        const parametersContainer = document.getElementById('parameters-container');
        const addParameterBtn = document.getElementById('add-parameter');
        const toggleParametersBtn = document.querySelector('.toggle-parameters');
        
        // Helper function to format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString();
        }
        
        // Helper function to determine job status
        function getJobStatus(job) {
            if (job.finished) {
                return 'completed';
            }
            return job.started ? 'running' : 'pending';
        }
        
        // Helper function to get overall job status from tasks
        function getOverallJobStatus(tasks) {
            if (!tasks || tasks.length === 0) return 'pending';
            
            const statuses = tasks.map(task => getJobStatus(task));
            
            if (statuses.includes('failed')) return 'failed';
            if (statuses.includes('running')) return 'running';
            if (statuses.every(status => status === 'completed')) return 'completed';
            return 'pending';
        }
        
        // Helper function to count tasks by status
        function countTasksByStatus(tasks) {
            const counts = {
                running: 0,
                completed: 0,
                failed: 0,
                pending: 0
            };
            
            if (!tasks) return counts;
            
            tasks.forEach(task => {
                counts[getJobStatus(task)]++;
            });
            
            return counts;
        }
        
        // Helper function to update last updated time
        function updateLastUpdated() {
            const now = new Date();
            lastUpdatedEl.textContent = `Last updated: ${now.toLocaleString()}`;
        }
        
        // Helper function to download job result
        async function downloadJobResult(jobId, taskId = null) {
            try {
                let url = `${API_BASE_URL}job/result?job_id=${jobId}&chunked=false`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Failed to download result');
                }
                
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `job_${jobId}${taskId ? `_task_${taskId}` : ''}_result.bin`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);
            } catch (error) {
                console.error('Error downloading job result:', error);
                alert('Error downloading job result: ' + error.message);
            }
        }
        
        // Add parameter row to the form
        function addParameterRow(key = '', value = '') {
            const paramRow = document.createElement('div');
            paramRow.className = 'parameter-row';
            paramRow.innerHTML = `
                <input type="text" placeholder="Parameter name" class="param-key" value="${key}">
                <input type="text" placeholder="Parameter value" class="param-value" value="${value}">
                <button type="button" class="btn btn-danger remove-parameter">&times;</button>
            `;
            parametersContainer.appendChild(paramRow);
            
            // Add event listener to remove button
            paramRow.querySelector('.remove-parameter').addEventListener('click', () => {
                parametersContainer.removeChild(paramRow);
            });
        }
        
        // Fetch job types
        async function fetchJobTypes() {
            try {
                const response = await fetch(`${API_BASE_URL}job/types`);
                const data = await response.json();
                
                // Clear existing options
                jobTypeSelect.innerHTML = '<option value="">Select a job type</option>';
                
                // Add new options from API response
                if (data.job_types && data.job_types.length > 0) {
                    data.job_types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        jobTypeSelect.appendChild(option);
                    });
                }
                
                return data;
            } catch (error) {
                console.error('Error fetching job types:', error);
                return null;
            }
        }
        
        // Fetch job list
        async function fetchJobList() {
            try {
                const response = await fetch(`${API_BASE_URL}job/list`);
                const data = await response.json();
                
                // Update status counts
                let runningCount = 0;
                let completedCount = 0;
                let failedCount = 0;
                
                if (data.jobs && data.jobs.length > 0) {
                    // Group tasks by job_id
                    const tasksByJob = {};
                    if (data.job_instances) {
                        data.job_instances.forEach(task => {
                            if (!tasksByJob[task.job_id]) {
                                tasksByJob[task.job_id] = [];
                            }
                            tasksByJob[task.job_id].push(task);
                        });
                    }
                    
                    data.jobs.forEach(job => {
                        const tasks = tasksByJob[job.job_id] || [];
                        const status = getOverallJobStatus(tasks);
                        if (status === 'running') runningCount++;
                        else if (status === 'completed') completedCount++;
                        else if (status === 'failed') failedCount++;
                    });
                }
                
                runningJobsEl.textContent = runningCount;
                completedJobsEl.textContent = completedCount;
                failedJobsEl.textContent = failedCount;
                
                // Update jobs table
                jobsTableBody.innerHTML = '';
                
                if (data.jobs && data.jobs.length > 0) {
                    // Group tasks by job_id
                    const tasksByJob = {};
                    if (data.job_instances) {
                        data.job_instances.forEach(task => {
                            if (!tasksByJob[task.job_id]) {
                                tasksByJob[task.job_id] = [];
                            }
                            tasksByJob[task.job_id].push(task);
                        });
                    }
                    
                    data.jobs.forEach(job => {
                        const tasks = tasksByJob[job.job_id] || [];
                        const status = getOverallJobStatus(tasks);
                        const statusClass = `status-${status}`;
                        const statusText = status.charAt(0).toUpperCase() + status.slice(1);
                        
                        const taskCounts = countTasksByStatus(tasks);
                        
                        const row = document.createElement('tr');
                        row.dataset.jobId = job.job_id;
                        row.innerHTML = `
                            <td>${job.job_id}</td>
                            <td>${job.job_type || 'N/A'}</td>
                            <td><span class="job-status ${statusClass}">${statusText}</span></td>
                            <td>
                                ${taskCounts.running ? `<span class="job-status status-running">${taskCounts.running} running</span> ` : ''}
                                ${taskCounts.completed ? `<span class="job-status status-completed">${taskCounts.completed} completed</span> ` : ''}
                                ${taskCounts.failed ? `<span class="job-status status-failed">${taskCounts.failed} failed</span> ` : ''}
                                ${taskCounts.pending ? `<span class="job-status status-pending">${taskCounts.pending} pending</span>` : ''}
                            </td>
                            <td>
                                <button class="btn btn-primary btn-view-job" data-job-id="${job.job_id}">View</button>
                            </td>
                        `;
                        jobsTableBody.appendChild(row);
                    });
                    
                    // Add event listeners to view buttons
                    document.querySelectorAll('.btn-view-job').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            currentJobId = e.target.dataset.jobId;
                            showJobDetails(currentJobId, data.jobs, data.job_instances);
                        });
                    });
                    
                    // Implement search functionality
                    jobSearchInput.addEventListener('input', () => {
                        const searchTerm = jobSearchInput.value.toLowerCase();
                        const rows = jobsTableBody.querySelectorAll('tr');
                        
                        rows.forEach(row => {
                            const jobId = row.cells[0].textContent.toLowerCase();
                            const jobType = row.cells[1].textContent.toLowerCase();
                            const shouldShow = jobId.includes(searchTerm) || jobType.includes(searchTerm);
                            row.style.display = shouldShow ? '' : 'none';
                        });
                    });
                } else {
                    jobsTableBody.innerHTML = '<tr><td colspan="5">No jobs found</td></tr>';
                }
                
                updateLastUpdated();
                return data;
            } catch (error) {
                console.error('Error fetching job list:', error);
                runningJobsEl.textContent = 'Error';
                completedJobsEl.textContent = 'Error';
                failedJobsEl.textContent = 'Error';
                jobsTableBody.innerHTML = '<tr><td colspan="5">Error loading jobs</td></tr>';
                return null;
            }
        }
        
        // Fetch single job info
        async function fetchJobInfo(jobId) {
            try {
                const response = await fetch(`${API_BASE_URL}job?job_id=${jobId}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching job info:', error);
                return null;
            }
        }
        
        // Submit new job
        async function submitJob(jobType, asBackground) {
            try {
                // Collect parameters
                const params = {};
                const paramRows = parametersContainer.querySelectorAll('.parameter-row');
                
                paramRows.forEach(row => {
                    const key = row.querySelector('.param-key').value;
                    const value = row.querySelector('.param-value').value;
                    if (key) {
                        params[key] = value;
                    }
                });
                
                const response = await fetch(`${API_BASE_URL}job`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        job_type: jobType,
                        as_background: asBackground,
                        ...params
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Job submitted successfully!');
                    fetchJobList(); // Refresh job list
                    jobSubmitForm.reset(); // Reset form
                    parametersContainer.innerHTML = ''; // Clear parameters
                    parametersSection.classList.remove('expanded');
                } else {
                    alert('Error submitting job: ' + (data.detail || 'Unknown error'));
                }
                
                return data;
            } catch (error) {
                console.error('Error submitting job:', error);
                alert('Error submitting job. See console for details.');
                return null;
            }
        }
        
        // Cancel job
        async function cancelJob(jobId) {
            try {
                const response = await fetch(`${API_BASE_URL}job/cancel?job_id=${jobId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Job cancellation requested!');
                    fetchJobList(); // Refresh job list
                    jobDetailsModal.style.display = 'none'; // Close modal
                } else {
                    alert('Error canceling job: ' + (data.detail || 'Unknown error'));
                }
                
                return data;
            } catch (error) {
                console.error('Error canceling job:', error);
                alert('Error canceling job. See console for details.');
                return null;
            }
        }
        
        // Show job details with tasks
        async function showJobDetails(jobId, jobsData, jobInstancesData) {
            // Find the job summary
            const job = jobsData?.find(j => j.job_id === jobId);
            
            // Find all tasks for this job
            const tasks = jobInstancesData?.filter(task => task.job_id === jobId) || [];
            
            if (job) {
                const status = getOverallJobStatus(tasks);
                
                let detailsHtml = `
                    <h4>Job Summary</h4>
                    <p><strong>Job ID:</strong> ${job.job_id}</p>
                    <p><strong>Type:</strong> ${job.job_type || 'N/A'}</p>
                    <p><strong>Overall Status:</strong> <span class="job-status status-${status}">${
                        status.charAt(0).toUpperCase() + status.slice(1)
                    }</span></p>
                    <p><strong>Supports Background:</strong> ${job.supports_background ? 'Yes' : 'No'}</p>
                `;
                
                if (job.requirements) {
                    detailsHtml += '<h5>Requirements</h5><pre>' + JSON.stringify(job.requirements, null, 2) + '</pre>';
                }

                // Show tasks table
                if (tasks.length > 0) {
                    detailsHtml += '<h5>Args</h5><pre>' + JSON.stringify(tasks[0].job_kwargs, null, 2) + '</pre>';
                }

                // Show tasks table
                if (tasks.length > 0) {
                    detailsHtml += `
                        <h4>Tasks</h4>
                        <table class="tasks-table">
                            <thead>
                                <tr>
                                    <th>Task ID</th>
                                    <th>Status</th>
                                    <th>Started</th>
                                    <th>Finished</th>
                                    <th>Node</th>
                                    <th>Output</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    tasks.forEach(task => {
                        const taskStatus = getJobStatus(task);
                        const taskStatusClass = `status-${taskStatus}`;
                        const taskStatusText = taskStatus.charAt(0).toUpperCase() + taskStatus.slice(1);
                        
                        detailsHtml += `
                            <tr>
                                <td>${task.instance_id || 'N/A'}</td>
                                <td><span class="task-status ${taskStatusClass}">${taskStatusText}</span></td>
                                <td>${formatDate(task.started)}</td>
                                <td>${formatDate(task.finished)}</td>
                                <td>${task.runtime_info?.node_ip_address || 'N/A'}</td>
                                <td>
                        `;
                        
                        if (task.finished) {
                            if (!task.is_inline_output) {
                                detailsHtml += `<span class="output-link" data-job-id="${job.job_id}" data-task-id="${task.instance_id}">Download</span>`;
                            } else {
                                detailsHtml += 'Inline';
                            }
                        } else {
                            detailsHtml += 'None';
                        }
                        
                        detailsHtml += `</td></tr>`;
                    });
                    
                    detailsHtml += `</tbody></table>`;
                } else {
                    detailsHtml += '<p>No tasks found for this job.</p>';
                }
                
                jobDetailsContent.innerHTML = detailsHtml;
                jobDetailsModal.style.display = 'flex';
                
                // Add click handlers for download links
                jobDetailsContent.querySelectorAll('.output-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        const jobId = e.target.dataset.jobId;
                        const taskId = e.target.dataset.taskId;
                        downloadJobResult(jobId, taskId);
                    });
                });
                
                // Only show cancel button for running/pending jobs
                if (status === 'running' || status === 'pending') {
                    cancelJobBtn.style.display = 'inline-block';
                    cancelJobBtn.dataset.jobId = job.job_id;
                } else {
                    cancelJobBtn.style.display = 'none';
                }
            } else {
                jobDetailsContent.innerHTML = '<p>Error loading job details</p>';
                jobDetailsModal.style.display = 'flex';
                cancelJobBtn.style.display = 'none';
            }
        }
        
        // Initialize the application
        async function init() {
            // Load initial data
            await Promise.all([
                fetchJobTypes(),
                fetchJobList()
            ]);
            
            // Set up refresh button
            refreshJobsBtn.addEventListener('click', fetchJobList);
            
            // Set up job submission form
            jobSubmitForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const jobType = jobTypeSelect.value;
                const asBackground = document.getElementById('as-background').checked;
                
                if (jobType) {
                    submitJob(jobType, asBackground);
                }
            });
            
            // Set up modal close buttons
            closeModalBtn.addEventListener('click', () => {
                jobDetailsModal.style.display = 'none';
            });
            
            closeModalBtnFooter.addEventListener('click', () => {
                jobDetailsModal.style.display = 'none';
            });
            
            // Set up cancel job button
            cancelJobBtn.addEventListener('click', () => {
                if (currentJobId) {
                    if (confirm('Are you sure you want to cancel this job?')) {
                        cancelJob(currentJobId);
                    }
                }
            });
            
            // Set up parameters section toggle
            toggleParametersBtn.addEventListener('click', () => {
                parametersSection.classList.toggle('expanded');
                toggleParametersBtn.textContent = parametersSection.classList.contains('expanded') ? 
                    '- Hide parameters' : '+ Add parameters';
            });
            
            // Set up add parameter button
            addParameterBtn.addEventListener('click', () => {
                addParameterRow();
            });
            
            // Set up periodic refresh (every 30 seconds)
            setInterval(fetchJobList, 30000);
        }
        
        // Start the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>